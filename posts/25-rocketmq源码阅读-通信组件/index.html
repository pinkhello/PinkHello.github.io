<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>RocketMQ源码阅读 通信组件 | pinkhello</title><link rel=canonical href=https://pinkhello.cc/posts/25-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/><meta name=description content="👷Hey! 我是 **pinkhello**，💻 一名后端程序员。**重要提示**: 在您阅读文章并评论之前，请先认真阅读[**评论承诺**](http://pinkhello.cc/promise)。"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="RocketMQ源码阅读 通信组件"><meta property="og:description" content="RocketMQ开箱源码详解-手握大哥大"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.cc/posts/25-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E9%80%9A%E4%BF%A1%E7%BB%84%E4%BB%B6/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-05-22T16:09:45+08:00"><meta property="article:modified_time" content="2021-05-22T16:09:45+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="RocketMQ源码阅读 通信组件"><meta name=twitter:description content="RocketMQ开箱源码详解-手握大哥大"><link rel=stylesheet href=https://pinkhello.cc/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://pinkhello.cc/images/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-M2FXWC325L","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://pinkhello.cc/posts/24-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-%E5%BC%80%E7%AF%87/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://pinkhello.cc/posts/26-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&text=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&is_video=false&description=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&name=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6&description=RocketMQ%e5%bc%80%e7%ae%b1%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3-%e6%89%8b%e6%8f%a1%e5%a4%a7%e5%93%a5%e5%a4%a7" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&t=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">RocketMQ源码阅读 通信组件</h1><div class=meta><div class=postdate><time datetime="2021-05-22 16:09:45 +0800 +0800" itemprop=datePublished>2021-05-22</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/tech>Tech</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/rocketmq rel=tag>RocketMQ</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#接口-remotingservice>接口 RemotingService</a></li><li><a href=#接口-remotingserver>接口 RemotingServer</a></li><li><a href=#实现-nettyremotingserver>实现 NettyRemotingServer</a></li></ul></nav></div><div class=content itemprop=articleBody><h1 id=rocketmq-核心基石>RocketMQ 核心基石</h1><p>前面已经介绍了 <code>RocketMQ</code> 的基本的概念和组件。今天我们开启真正的源码的阅读诗篇, <code>RocketMQ</code> 消息系各个组件 <code>Producer</code>、<code>Consumer</code>、<code>Broker</code>、<code>NameSrv</code> 通通离不开交互，那是使用的什么交互的呢。答案是TCP长链接。
而 <code>RocketMQ</code> 开源代码内部，对通信相关的进行了一次封装，都在 rocketmq-remoting 模块下，这个模块被其他 <code>client</code>、<code>broker</code>、<code>namesrv</code> 应用。</p><p>直接先说 <code>remoting</code> 的实现是基于 <code>netty</code> 做了封装、启动了服务端和客户端，支持三种消息的发送方式:</p><ul><li>同步发送</li><li>单向发送 (不需要关注响应)</li><li>异步发送</li></ul><p>下图为异步通信流程
<img src=/rocketmq/rocketmq_remoting.png alt=rocketmq_remoting></p><h1 id=remoting-包下的核心接口体系>remoting 包下的核心接口体系</h1><p><img src=/rocketmq/package-remoting-uml.png alt="remoting uml"></p><h2 id=接口-remotingservice>接口 RemotingService</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RemotingService</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开启
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 关闭
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注册 RPCHook
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerRPCHook</span><span style=color:#f92672>(</span>RPCHook rpcHook<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=接口-remotingserver>接口 RemotingServer</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RemotingServer</span> <span style=color:#66d9ef>extends</span> RemotingService <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注册请求类型的处理器 【common 模块的 org.apache.rocketmq.common.protocol.RequestCode]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerProcessor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> NettyRequestProcessor processor<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> ExecutorService executor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 注册默认的处理器
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerDefaultProcessor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> NettyRequestProcessor processor<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> ExecutorService executor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 本地的端口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>localListenPort</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据 requestCode 获取处理器和业务线程池
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    Pair<span style=color:#f92672>&lt;</span>NettyRequestProcessor<span style=color:#f92672>,</span> ExecutorService<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getProcessorPair</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 同步发送
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    RemotingCommand <span style=color:#a6e22e>invokeSync</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Channel channel<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> RemotingCommand request<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>,</span> RemotingSendRequestException<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        RemotingTimeoutException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 异步发送
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeAsync</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Channel channel<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> RemotingCommand request<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> InvokeCallback invokeCallback<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        RemotingTooMuchRequestException<span style=color:#f92672>,</span> RemotingTimeoutException<span style=color:#f92672>,</span> RemotingSendRequestException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 单向发送
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>invokeOneway</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Channel channel<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> RemotingCommand request<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> InterruptedException<span style=color:#f92672>,</span> RemotingTooMuchRequestException<span style=color:#f92672>,</span> RemotingTimeoutException<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        RemotingSendRequestException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=实现-nettyremotingserver>实现 NettyRemotingServer</h2><p>这边选择性的进行摘取记录描述啊</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyRemotingServer</span> <span style=color:#66d9ef>extends</span> NettyRemotingAbstract <span style=color:#66d9ef>implements</span> RemotingServer <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// todo 此处代码省略号...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 构造
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>NettyRemotingServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> NettyServerConfig nettyServerConfig<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                               <span style=color:#66d9ef>final</span> ChannelEventListener channelEventListener<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//调用 NettyRemotingAbstract 的构造初始化相关配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>super</span><span style=color:#f92672>(</span>nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerOnewaySemaphoreValue</span><span style=color:#f92672>(),</span> nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerAsyncSemaphoreValue</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//开启一个ServerBootstrap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverBootstrap</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerBootstrap<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>nettyServerConfig</span> <span style=color:#f92672>=</span> nettyServerConfig<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>channelEventListener</span> <span style=color:#f92672>=</span> channelEventListener<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>//默认的 React
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>int</span> publicThreadNums <span style=color:#f92672>=</span> nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerCallbackExecutorThreads</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>publicThreadNums <span style=color:#f92672>&lt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            publicThreadNums <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>publicExecutor</span> <span style=color:#f92672>=</span> Executors<span style=color:#f92672>.</span><span style=color:#a6e22e>newFixedThreadPool</span><span style=color:#f92672>(</span>publicThreadNums<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> ThreadFactory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>private</span> AtomicInteger threadIndex <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;NettyServerPublicExecutor_&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadIndex</span><span style=color:#f92672>.</span><span style=color:#a6e22e>incrementAndGet</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//根据系统环境或指的配置选择使用 Epoll 还是 Nio 模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>useEpoll<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//构建 EventLoopGroup 只有1个线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventLoopGroupBoss</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EpollEventLoopGroup<span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> ThreadFactory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>private</span> AtomicInteger threadIndex <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;NettyEPOLLBoss_%d&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadIndex</span><span style=color:#f92672>.</span><span style=color:#a6e22e>incrementAndGet</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//构建 eventLoopGroupSelector
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventLoopGroupSelector</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> EpollEventLoopGroup<span style=color:#f92672>(</span>nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerSelectorThreads</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> ThreadFactory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>private</span> AtomicInteger threadIndex <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> threadTotal <span style=color:#f92672>=</span> nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerSelectorThreads</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;NettyServerEPOLLSelector_%d_%d&#34;</span><span style=color:#f92672>,</span> threadTotal<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadIndex</span><span style=color:#f92672>.</span><span style=color:#a6e22e>incrementAndGet</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// todo 此处代码省略号...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//夹在SSL上下文
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        loadSslContext<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>//todo 此处代码省略号...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 核心的 启动方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//构建 Worker线程，根据配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultEventExecutorGroup</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultEventExecutorGroup<span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerWorkerThreads</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> ThreadFactory<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>private</span> AtomicInteger threadIndex <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>public</span> Thread <span style=color:#a6e22e>newThread</span><span style=color:#f92672>(</span>Runnable r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(</span>r<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;NettyServerCodecThread_&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>threadIndex</span><span style=color:#f92672>.</span><span style=color:#a6e22e>incrementAndGet</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 准备共享式的Hanlders 包含了SSL 、编解码、连接管理、业务handler
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        prepareSharableHandlers<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//开启一个 Netty Server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        ServerBootstrap childHandler <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverBootstrap</span><span style=color:#f92672>.</span><span style=color:#a6e22e>group</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventLoopGroupBoss</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>eventLoopGroupSelector</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>channel</span><span style=color:#f92672>(</span>useEpoll<span style=color:#f92672>()</span> <span style=color:#f92672>?</span> EpollServerSocketChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span> <span style=color:#f92672>:</span> NioServerSocketChannel<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>option</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>SO_BACKLOG</span><span style=color:#f92672>,</span> 1024<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>option</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>SO_REUSEADDR</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>option</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>SO_KEEPALIVE</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>childOption</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>TCP_NODELAY</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>childOption</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>SO_SNDBUF</span><span style=color:#f92672>,</span> nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerSocketSndBufSize</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>childOption</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>SO_RCVBUF</span><span style=color:#f92672>,</span> nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerSocketRcvBufSize</span><span style=color:#f92672>())</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>localAddress</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InetSocketAddress<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>nettyServerConfig</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getListenPort</span><span style=color:#f92672>()))</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>.</span><span style=color:#a6e22e>childHandler</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> ChannelInitializer<span style=color:#f92672>&lt;</span>SocketChannel<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initChannel</span><span style=color:#f92672>(</span>SocketChannel ch<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                ch<span style=color:#f92672>.</span><span style=color:#a6e22e>pipeline</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>.</span><span style=color:#a6e22e>addLast</span><span style=color:#f92672>(</span>defaultEventExecutorGroup<span style=color:#f92672>,</span> HANDSHAKE_HANDLER_NAME<span style=color:#f92672>,</span> handshakeHandler<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>.</span><span style=color:#a6e22e>addLast</span><span style=color:#f92672>(</span>defaultEventExecutorGroup<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                encoder<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                <span style=color:#66d9ef>new</span> NettyDecoder<span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                                                <span style=color:#66d9ef>new</span> IdleStateHandler<span style=color:#f92672>(</span>0<span style=color:#f92672>,</span> 0<span style=color:#f92672>,</span> nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>getServerChannelMaxIdleTimeSeconds</span><span style=color:#f92672>()),</span>
</span></span><span style=display:flex><span>                                                connectionManageHandler<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                serverHandler
</span></span><span style=display:flex><span>                                        <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>nettyServerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>isServerPooledByteBufAllocatorEnable</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            childHandler<span style=color:#f92672>.</span><span style=color:#a6e22e>childOption</span><span style=color:#f92672>(</span>ChannelOption<span style=color:#f92672>.</span><span style=color:#a6e22e>ALLOCATOR</span><span style=color:#f92672>,</span> PooledByteBufAllocator<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 开启一个 Netty Server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            ChannelFuture sync <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serverBootstrap</span><span style=color:#f92672>.</span><span style=color:#a6e22e>bind</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sync</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            InetSocketAddress addr <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>InetSocketAddress<span style=color:#f92672>)</span> sync<span style=color:#f92672>.</span><span style=color:#a6e22e>channel</span><span style=color:#f92672>().</span><span style=color:#a6e22e>localAddress</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> addr<span style=color:#f92672>.</span><span style=color:#a6e22e>getPort</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e1<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;this.serverBootstrap.bind().sync() InterruptedException&#34;</span><span style=color:#f92672>,</span> e1<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>channelEventListener</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>nettyEventExecutor</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 开启扫描 ResponseTable 的检查线程
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleAtFixedRate</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TimerTask<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    NettyRemotingServer<span style=color:#f92672>.</span><span style=color:#a6e22e>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>scanResponseTable</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scanResponseTable exception&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>,</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>//todo 此处代码省略号...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 这个是核心代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@ChannelHandler.Sharable</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyServerHandler</span> <span style=color:#66d9ef>extends</span> SimpleChannelInboundHandler<span style=color:#f92672>&lt;</span>RemotingCommand<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>channelRead0</span><span style=color:#f92672>(</span>ChannelHandlerContext ctx<span style=color:#f92672>,</span> RemotingCommand msg<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 调用消息处理的方法  这个方法 在 NettyRemotingAbstract 类内上
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            processMessageReceived<span style=color:#f92672>(</span>ctx<span style=color:#f92672>,</span> msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//todo 此处代码省略号...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyRemotingAbstract</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 根据消息的类型进行处理，是请求还是响应的CMD
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>processMessageReceived</span><span style=color:#f92672>(</span>ChannelHandlerContext ctx<span style=color:#f92672>,</span> RemotingCommand msg<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> RemotingCommand cmd <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>cmd <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> REQUEST_COMMAND<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//处理请求指令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    processRequestCommand<span style=color:#f92672>(</span>ctx<span style=color:#f92672>,</span> cmd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> RESPONSE_COMMAND<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//处理响应指令
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    processResponseCommand<span style=color:#f92672>(</span>ctx<span style=color:#f92672>,</span> cmd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>好了，到现在我们大体的 remoting server 端的大体的入口和核心处理方法差不多了，后面补充一下 RocketMQ Netty Reactor 多线程的设计</p><p><img src=/rocketmq/rocketmq_reactor_thread.png alt=rocketmq_reactor_thread></p><p>简单概括： <code>1-N-M1-M2</code> 模型</p><table><thead><tr><th style=text-align:left>线程数</th><th style=text-align:left>线程名</th><th style=text-align:left>线程具体说明</th><th style=text-align:left>代码默认值</th></tr></thead><tbody><tr><td style=text-align:left>1</td><td style=text-align:left>NettyBoss_%d</td><td style=text-align:left>Reactor主线程</td><td style=text-align:left>1</td></tr><tr><td style=text-align:left>N</td><td style=text-align:left>NettyServerEPOLLSelector_%d_%d</td><td style=text-align:left>Reactor线程池</td><td style=text-align:left>3</td></tr><tr><td style=text-align:left>M1</td><td style=text-align:left>NettyServerCodecThread_%d</td><td style=text-align:left>Worker线程池</td><td style=text-align:left>8</td></tr><tr><td style=text-align:left>M2</td><td style=text-align:left>RemotingExecutorThread_%d</td><td style=text-align:left>业务<code>processor</code>处理线程池</td><td style=text-align:left>8</td></tr></tbody></table><ul><li>[Reactor主线程] <code>1</code>, 一个 <code>Reactor主线程</code>(<code>eventLoopGroupBoss</code>) 负责监听 <code>TCP</code>网络链接请求，建立好链接，创建<code>SocketChannel</code>、并注册到<code>selector</code>上。</li><li>[Reactor线程池] <code>N=3</code>, <code>RocketMQ</code> 根据<code>OS或者配置</code>选择<code>NIO</code>还是<code>Epoll</code>，然后监听真正的网络数据。后面拿到数据后，丢给 <code>Reactor线程池</code> (<code>eventLoopGroupSelector</code>),</li><li>[Worker线程池] <code>M1=8</code>, 在执行业务逻辑之前的 <code>SSL验证</code>、<code>编解码</code>、<code>空闲检查</code>、<code>网络连接管理</code>等等，这些工作交给了 <code>defaultEventExecutorGroup</code></li><li>[业务<code>processor</code>处理线程池] <code>M2=8</code>, 处理业务操作的放在了业务线程池来执行，根据 <code>RemotingCommand</code> 的<code>业务码 code</code> 在 <code>processorTable</code> 缓存中获取到对应的 <code>processor</code>, 然后封装成<code>Task任务</code>，提交给<code>业务processor</code>处理线程池来执行 (eg: <code>sendMessageExecutor</code>,消息发送为例)</li></ul><p>备注: 特别要说明 业务<code>processor</code>处理线程池 不一定是<code>8</code>,具体看代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>NettyRemotingServer</span> <span style=color:#66d9ef>extends</span> NettyRemotingAbstract <span style=color:#66d9ef>implements</span> RemotingServer<span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//todo .....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//注册Processor，一般 executor ！= null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerProcessor</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> requestCode<span style=color:#f92672>,</span> NettyRequestProcessor processor<span style=color:#f92672>,</span> ExecutorService executor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      ExecutorService executorThis <span style=color:#f92672>=</span> executor<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> executor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        executorThis <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>publicExecutor</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Pair<span style=color:#f92672>&lt;</span>NettyRequestProcessor<span style=color:#f92672>,</span> ExecutorService<span style=color:#f92672>&gt;</span> pair <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Pair<span style=color:#f92672>&lt;</span>NettyRequestProcessor<span style=color:#f92672>,</span> ExecutorService<span style=color:#f92672>&gt;(</span>processor<span style=color:#f92672>,</span> executorThis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>processorTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>requestCode<span style=color:#f92672>,</span> pair<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>//注册默认的Processor，一般 executor ！= null
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerDefaultProcessor</span><span style=color:#f92672>(</span>NettyRequestProcessor processor<span style=color:#f92672>,</span> ExecutorService executor<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultRequestProcessor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Pair<span style=color:#f92672>&lt;</span>NettyRequestProcessor<span style=color:#f92672>,</span> ExecutorService<span style=color:#f92672>&gt;(</span>processor<span style=color:#f92672>,</span> executor<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//todo .....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这边结合理解差不多了。</p><h1 id=remotingcommand>RemotingCommand</h1><p>上面看见了在处理消息的时候一个很核心的类 下面来看一下这个类 org.apache.rocketmq.remoting.protocol.RemotingCommand</p><p>它其实是 rocketmq的指令协议</p><table><thead><tr><th>Header字段</th><th>类型</th><th>Request说明</th><th>Response说明</th></tr></thead><tbody><tr><td>code</td><td>int</td><td>请求操作码，应答方根据不同的请求码进行不同的业务处理</td><td>应答响应码。0表示成功，非0则表示各种错误</td></tr><tr><td>language</td><td>LanguageCode</td><td>请求方实现的语言</td><td>应答方实现的语言</td></tr><tr><td>version</td><td>int</td><td>请求方程序的版本</td><td>应答方程序的版本</td></tr><tr><td>opaque</td><td>int</td><td>相当于requestId，在同一个连接上的不同请求标识码，与响应消息中的相对应</td><td>应答不做修改直接返回</td></tr><tr><td>flag</td><td>int</td><td>区分是普通RPC还是onewayRPC得标志</td><td>区分是普通RPC还是onewayRPC得标志</td></tr><tr><td>remark</td><td>String</td><td>传输自定义文本信息</td><td>传输自定义文本信息</td></tr><tr><td>extFields</td><td>HashMap&lt;String, String></td><td>请求自定义扩展信息</td><td>响应自定义扩展信息</td></tr></tbody></table><p>协议编码后的样子
<img src=/rocketmq/rocketmq_protocol_length.png alt=rocketmq_protocol_length></p><p>4个部分:</p><ul><li>消息长度: 总长度, 4 个字节存储, int 类型</li><li>序列话类型&消息头长度: int 类型, 第一个字节表示序列化类型, 后面三个字节表示消息头长度</li><li>消息头数据: 经过序列化后的消息头</li><li>消息主体数据: 消息主体的二进制字节数据</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RemotingCommand</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String SERIALIZE_TYPE_PROPERTY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rocketmq.serialize.type&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String SERIALIZE_TYPE_ENV <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ROCKETMQ_SERIALIZE_TYPE&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String REMOTING_VERSION_KEY <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rocketmq.remoting.version&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> InternalLogger log <span style=color:#f92672>=</span> InternalLoggerFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>getLogger</span><span style=color:#f92672>(</span>RemotingHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>ROCKETMQ_REMOTING</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> RPC_TYPE <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> <span style=color:#75715e>// 0, REQUEST_COMMAND
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> RPC_ONEWAY <span style=color:#f92672>=</span> 1<span style=color:#f92672>;</span> <span style=color:#75715e>// 0, RPC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CommandCustomHeader<span style=color:#f92672>&gt;,</span> Field<span style=color:#f92672>[]&gt;</span> CLASS_HASH_MAP <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CommandCustomHeader<span style=color:#f92672>&gt;,</span> Field<span style=color:#f92672>[]&gt;();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> CANONICAL_NAME_CACHE <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>Class<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 1, Oneway
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// 1, RESPONSE_COMMAND
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>Field<span style=color:#f92672>,</span> Boolean<span style=color:#f92672>&gt;</span> NULLABLE_FIELD_CACHE <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>Field<span style=color:#f92672>,</span> Boolean<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String STRING_CANONICAL_NAME <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DOUBLE_CANONICAL_NAME_1 <span style=color:#f92672>=</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String DOUBLE_CANONICAL_NAME_2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>double</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String INTEGER_CANONICAL_NAME_1 <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String INTEGER_CANONICAL_NAME_2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>int</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String LONG_CANONICAL_NAME_1 <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String LONG_CANONICAL_NAME_2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>long</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BOOLEAN_CANONICAL_NAME_1 <span style=color:#f92672>=</span> Boolean<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BOOLEAN_CANONICAL_NAME_2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>boolean</span><span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> configVersion <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> AtomicInteger requestId <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> SerializeType serializeTypeConfigInThisServer <span style=color:#f92672>=</span> SerializeType<span style=color:#f92672>.</span><span style=color:#a6e22e>JSON</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String protocol <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>SERIALIZE_TYPE_PROPERTY<span style=color:#f92672>,</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getenv</span><span style=color:#f92672>(</span>SERIALIZE_TYPE_ENV<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isBlank<span style=color:#f92672>(</span>protocol<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        serializeTypeConfigInThisServer <span style=color:#f92672>=</span> SerializeType<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>protocol<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalArgumentException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;parser specified protocol error. protocol=&#34;</span> <span style=color:#f92672>+</span> protocol<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 请求码操作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 语言类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> LanguageCode language <span style=color:#f92672>=</span> LanguageCode<span style=color:#f92672>.</span><span style=color:#a6e22e>JAVA</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> version <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// requestId，标记请求响应是一个映射的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> opaque <span style=color:#f92672>=</span> requestId<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 区分是普通RPC还是onewayRPC得标志
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>int</span> flag <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 传输自定义文本信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> String remark<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 请求自定义扩展信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> extFields<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>transient</span> CommandCustomHeader customHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> SerializeType serializeTypeCurrentRPC <span style=color:#f92672>=</span> serializeTypeConfigInThisServer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>transient</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>RemotingCommand</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//创建 requestCommand
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> CommandCustomHeader customHeader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    RemotingCommand cmd <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RemotingCommand<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>setCode</span><span style=color:#f92672>(</span>code<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>customHeader</span> <span style=color:#f92672>=</span> customHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    setCmdVersion<span style=color:#f92672>(</span>cmd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cmd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//设置程序版本
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCmdVersion</span><span style=color:#f92672>(</span>RemotingCommand cmd<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>configVersion <span style=color:#f92672>&gt;=</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>setVersion</span><span style=color:#f92672>(</span>configVersion<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      String v <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>REMOTING_VERSION_KEY<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>v <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> value <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>v<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>setVersion</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        configVersion <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>createResponseCommand</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CommandCustomHeader<span style=color:#f92672>&gt;</span> classHeader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> createResponseCommand<span style=color:#f92672>(</span>RemotingSysResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SYSTEM_ERROR</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;not set any response code&#34;</span><span style=color:#f92672>,</span> classHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>createResponseCommand</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> String remark<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                                                      Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CommandCustomHeader<span style=color:#f92672>&gt;</span> classHeader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    RemotingCommand cmd <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> RemotingCommand<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>markResponseType</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>setCode</span><span style=color:#f92672>(</span>code<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>setRemark</span><span style=color:#f92672>(</span>remark<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    setCmdVersion<span style=color:#f92672>(</span>cmd<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>classHeader <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        CommandCustomHeader objectHeader <span style=color:#f92672>=</span> classHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>customHeader</span> <span style=color:#f92672>=</span> objectHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InstantiationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cmd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>createResponseCommand</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>,</span> String remark<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> createResponseCommand<span style=color:#f92672>(</span>code<span style=color:#f92672>,</span> remark<span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> array<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    ByteBuffer byteBuffer <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>wrap</span><span style=color:#f92672>(</span>array<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> decode<span style=color:#f92672>(</span>byteBuffer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> ByteBuffer byteBuffer<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> length <span style=color:#f92672>=</span> byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>limit</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> oriHeaderLen <span style=color:#f92672>=</span> byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>getInt</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> headerLength <span style=color:#f92672>=</span> getHeaderLength<span style=color:#f92672>(</span>oriHeaderLen<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> headerData <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>headerLength<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>    byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>headerData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    RemotingCommand cmd <span style=color:#f92672>=</span> headerDecode<span style=color:#f92672>(</span>headerData<span style=color:#f92672>,</span> getProtocolType<span style=color:#f92672>(</span>oriHeaderLen<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> bodyLength <span style=color:#f92672>=</span> length <span style=color:#f92672>-</span> 4 <span style=color:#f92672>-</span> headerLength<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bodyData <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>bodyLength <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      bodyData <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>bodyLength<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>      byteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>bodyData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    cmd<span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> bodyData<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> cmd<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getHeaderLength</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> length<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> length <span style=color:#f92672>&amp;</span> 0xFFFFFF<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//消息头解码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> RemotingCommand <span style=color:#a6e22e>headerDecode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> headerData<span style=color:#f92672>,</span> SerializeType type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> JSON<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        RemotingCommand resultJson <span style=color:#f92672>=</span> RemotingSerializable<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>headerData<span style=color:#f92672>,</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        resultJson<span style=color:#f92672>.</span><span style=color:#a6e22e>setSerializeTypeCurrentRPC</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> resultJson<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> ROCKETMQ<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        RemotingCommand resultRMQ <span style=color:#f92672>=</span> RocketMQSerializable<span style=color:#f92672>.</span><span style=color:#a6e22e>rocketMQProtocolDecode</span><span style=color:#f92672>(</span>headerData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        resultRMQ<span style=color:#f92672>.</span><span style=color:#a6e22e>setSerializeTypeCurrentRPC</span><span style=color:#f92672>(</span>type<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> resultRMQ<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> SerializeType <span style=color:#a6e22e>getProtocolType</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> source<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> SerializeType<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>((</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> <span style=color:#f92672>((</span>source <span style=color:#f92672>&gt;&gt;</span> 24<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> 0xFF<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>createNewRequestId</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> requestId<span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> SerializeType <span style=color:#a6e22e>getSerializeTypeConfigInThisServer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> serializeTypeConfigInThisServer<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isBlank</span><span style=color:#f92672>(</span>String str<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> strLen<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>str <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#f92672>(</span>strLen <span style=color:#f92672>=</span> str<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>())</span> <span style=color:#f92672>==</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> strLen<span style=color:#f92672>;</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>Character<span style=color:#f92672>.</span><span style=color:#a6e22e>isWhitespace</span><span style=color:#f92672>(</span>str<span style=color:#f92672>.</span><span style=color:#a6e22e>charAt</span><span style=color:#f92672>(</span>i<span style=color:#f92672>)))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//设置协议类型
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>markProtocolType</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> source<span style=color:#f92672>,</span> SerializeType type<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[</span>4<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    result<span style=color:#f92672>[</span>1<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> <span style=color:#f92672>((</span>source <span style=color:#f92672>&gt;&gt;</span> 16<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> 0xFF<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    result<span style=color:#f92672>[</span>2<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> <span style=color:#f92672>((</span>source <span style=color:#f92672>&gt;&gt;</span> 8<span style=color:#f92672>)</span> <span style=color:#f92672>&amp;</span> 0xFF<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    result<span style=color:#f92672>[</span>3<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>)</span> <span style=color:#f92672>(</span>source <span style=color:#f92672>&amp;</span> 0xFF<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>markResponseType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> bits <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> RPC_TYPE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>|=</span> bits<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> CommandCustomHeader <span style=color:#a6e22e>readCustomHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> customHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>writeCustomHeader</span><span style=color:#f92672>(</span>CommandCustomHeader customHeader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>customHeader</span> <span style=color:#f92672>=</span> customHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> CommandCustomHeader <span style=color:#a6e22e>decodeCommandCustomHeader</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>          Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CommandCustomHeader<span style=color:#f92672>&gt;</span> classHeader<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemotingCommandException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    CommandCustomHeader objectHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      objectHeader <span style=color:#f92672>=</span> classHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>newInstance</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InstantiationException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>IllegalAccessException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//解码定制的扩展信息字段
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extFields</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      Field<span style=color:#f92672>[]</span> fields <span style=color:#f92672>=</span> getClazzFields<span style=color:#f92672>(</span>classHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Field field <span style=color:#f92672>:</span> fields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isStatic</span><span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          String fieldName <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>fieldName<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;this&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              String value <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extFields</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>fieldName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isFieldNullable<span style=color:#f92672>(</span>field<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                  <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingCommandException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;the custom field &lt;&#34;</span> <span style=color:#f92672>+</span> fieldName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&gt; is null&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              String type <span style=color:#f92672>=</span> getCanonicalName<span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>getType</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>              Object valueParsed<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>STRING_CANONICAL_NAME<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                valueParsed <span style=color:#f92672>=</span> value<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>INTEGER_CANONICAL_NAME_1<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>INTEGER_CANONICAL_NAME_2<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                valueParsed <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>LONG_CANONICAL_NAME_1<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>LONG_CANONICAL_NAME_2<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                valueParsed <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>BOOLEAN_CANONICAL_NAME_1<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>BOOLEAN_CANONICAL_NAME_2<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                valueParsed <span style=color:#f92672>=</span> Boolean<span style=color:#f92672>.</span><span style=color:#a6e22e>parseBoolean</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>DOUBLE_CANONICAL_NAME_1<span style=color:#f92672>)</span> <span style=color:#f92672>||</span> type<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>DOUBLE_CANONICAL_NAME_2<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                valueParsed <span style=color:#f92672>=</span> Double<span style=color:#f92672>.</span><span style=color:#a6e22e>parseDouble</span><span style=color:#f92672>(</span>value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingCommandException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;the custom field &lt;&#34;</span> <span style=color:#f92672>+</span> fieldName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&gt; type is not supported&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>              field<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>objectHeader<span style=color:#f92672>,</span> valueParsed<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Failed field [{}] decoding&#34;</span><span style=color:#f92672>,</span> fieldName<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      objectHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>checkFields</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> objectHeader<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> Field<span style=color:#f92672>[]</span> <span style=color:#a6e22e>getClazzFields</span><span style=color:#f92672>(</span>Class<span style=color:#f92672>&lt;?</span> <span style=color:#66d9ef>extends</span> CommandCustomHeader<span style=color:#f92672>&gt;</span> classHeader<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    Field<span style=color:#f92672>[]</span> field <span style=color:#f92672>=</span> CLASS_HASH_MAP<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>classHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>field <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      field <span style=color:#f92672>=</span> classHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>getDeclaredFields</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>CLASS_HASH_MAP<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        CLASS_HASH_MAP<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>classHeader<span style=color:#f92672>,</span> field<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> field<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isFieldNullable</span><span style=color:#f92672>(</span>Field field<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>NULLABLE_FIELD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>containsKey</span><span style=color:#f92672>(</span>field<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Annotation annotation <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>getAnnotation</span><span style=color:#f92672>(</span>CFNotNull<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>NULLABLE_FIELD_CACHE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        NULLABLE_FIELD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>field<span style=color:#f92672>,</span> annotation <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> NULLABLE_FIELD_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>field<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> String <span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>(</span>Class clazz<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    String name <span style=color:#f92672>=</span> CANONICAL_NAME_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>clazz<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>name <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      name <span style=color:#f92672>=</span> clazz<span style=color:#f92672>.</span><span style=color:#a6e22e>getCanonicalName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span>CANONICAL_NAME_CACHE<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        CANONICAL_NAME_CACHE<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>clazz<span style=color:#f92672>,</span> name<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> name<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// 编码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>public</span> ByteBuffer <span style=color:#a6e22e>encode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1&gt; header length size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> length <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2&gt; header data length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> headerData <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>headerEncode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    length <span style=color:#f92672>+=</span> headerData<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3&gt; body data length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      length <span style=color:#f92672>+=</span> body<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ByteBuffer result <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>allocate</span><span style=color:#f92672>(</span>4 <span style=color:#f92672>+</span> length<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>putInt</span><span style=color:#f92672>(</span>length<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// header length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>markProtocolType<span style=color:#f92672>(</span>headerData<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>,</span> serializeTypeCurrentRPC<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// header data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>headerData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// body data;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>flip</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>headerEncode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeCustomHeaderToNet</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>SerializeType<span style=color:#f92672>.</span><span style=color:#a6e22e>ROCKETMQ</span> <span style=color:#f92672>==</span> serializeTypeCurrentRPC<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> RocketMQSerializable<span style=color:#f92672>.</span><span style=color:#a6e22e>rocketMQProtocolEncode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> RemotingSerializable<span style=color:#f92672>.</span><span style=color:#a6e22e>encode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>makeCustomHeaderToNet</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>customHeader</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      Field<span style=color:#f92672>[]</span> fields <span style=color:#f92672>=</span> getClazzFields<span style=color:#f92672>(</span>customHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>getClass</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extFields</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extFields</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>Field field <span style=color:#f92672>:</span> fields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>Modifier<span style=color:#f92672>.</span><span style=color:#a6e22e>isStatic</span><span style=color:#f92672>(</span>field<span style=color:#f92672>.</span><span style=color:#a6e22e>getModifiers</span><span style=color:#f92672>()))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>          String name <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>name<span style=color:#f92672>.</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;this&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Object value <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              field<span style=color:#f92672>.</span><span style=color:#a6e22e>setAccessible</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>              value <span style=color:#f92672>=</span> field<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>customHeader</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Failed to access field [{}]&#34;</span><span style=color:#f92672>,</span> name<span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>value <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extFields</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>name<span style=color:#f92672>,</span> value<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> ByteBuffer <span style=color:#a6e22e>encodeHeader</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> encodeHeader<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span><span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>:</span> 0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> ByteBuffer <span style=color:#a6e22e>encodeHeader</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> bodyLength<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 1&gt; header length size
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>int</span> length <span style=color:#f92672>=</span> 4<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 2&gt; header data length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> headerData<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    headerData <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>headerEncode</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    length <span style=color:#f92672>+=</span> headerData<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 3&gt; body data length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    length <span style=color:#f92672>+=</span> bodyLength<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ByteBuffer result <span style=color:#f92672>=</span> ByteBuffer<span style=color:#f92672>.</span><span style=color:#a6e22e>allocate</span><span style=color:#f92672>(</span>4 <span style=color:#f92672>+</span> length <span style=color:#f92672>-</span> bodyLength<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>putInt</span><span style=color:#f92672>(</span>length<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// header length
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>markProtocolType<span style=color:#f92672>(</span>headerData<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span><span style=color:#f92672>,</span> serializeTypeCurrentRPC<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// header data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>headerData<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    result<span style=color:#f92672>.</span><span style=color:#a6e22e>flip</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>markOnewayRPC</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> bits <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> RPC_ONEWAY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>|=</span> bits<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@JSONField</span><span style=color:#f92672>(</span>serialize <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isOnewayRPC</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> bits <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> RPC_ONEWAY<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>&amp;</span> bits<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> bits<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getCode</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setCode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> code<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>code</span> <span style=color:#f92672>=</span> code<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@JSONField</span><span style=color:#f92672>(</span>serialize <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> RemotingCommandType <span style=color:#a6e22e>getType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isResponseType</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> RemotingCommandType<span style=color:#f92672>.</span><span style=color:#a6e22e>RESPONSE_COMMAND</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> RemotingCommandType<span style=color:#f92672>.</span><span style=color:#a6e22e>REQUEST_COMMAND</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@JSONField</span><span style=color:#f92672>(</span>serialize <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>isResponseType</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> bits <span style=color:#f92672>=</span> 1 <span style=color:#f92672>&lt;&lt;</span> RPC_TYPE<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>&amp;</span> bits<span style=color:#f92672>)</span> <span style=color:#f92672>==</span> bits<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> LanguageCode <span style=color:#a6e22e>getLanguage</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> language<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setLanguage</span><span style=color:#f92672>(</span>LanguageCode language<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>language</span> <span style=color:#f92672>=</span> language<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getVersion</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> version<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setVersion</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> version<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> version<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getOpaque</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> opaque<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setOpaque</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> opaque<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>opaque</span> <span style=color:#f92672>=</span> opaque<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>getFlag</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> flag<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setFlag</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> flag<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>flag</span> <span style=color:#f92672>=</span> flag<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>getRemark</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> remark<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setRemark</span><span style=color:#f92672>(</span>String remark<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remark</span> <span style=color:#f92672>=</span> remark<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>getBody</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span><span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> body<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>body</span> <span style=color:#f92672>=</span> body<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getExtFields</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> extFields<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setExtFields</span><span style=color:#f92672>(</span>HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> extFields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>extFields</span> <span style=color:#f92672>=</span> extFields<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>addExtField</span><span style=color:#f92672>(</span>String key<span style=color:#f92672>,</span> String value<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> extFields<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      extFields <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    extFields<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> value<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> String <span style=color:#a6e22e>toString</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;RemotingCommand [code=&#34;</span> <span style=color:#f92672>+</span> code <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, language=&#34;</span> <span style=color:#f92672>+</span> language <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, version=&#34;</span> <span style=color:#f92672>+</span> version <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, opaque=&#34;</span> <span style=color:#f92672>+</span> opaque <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, flag(B)=&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>toBinaryString</span><span style=color:#f92672>(</span>flag<span style=color:#f92672>)</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, remark=&#34;</span> <span style=color:#f92672>+</span> remark <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, extFields=&#34;</span> <span style=color:#f92672>+</span> extFields <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;, serializeTypeCurrentRPC=&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>+</span> serializeTypeCurrentRPC <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;]&#34;</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> SerializeType <span style=color:#a6e22e>getSerializeTypeCurrentRPC</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> serializeTypeCurrentRPC<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setSerializeTypeCurrentRPC</span><span style=color:#f92672>(</span>SerializeType serializeTypeCurrentRPC<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serializeTypeCurrentRPC</span> <span style=color:#f92672>=</span> serializeTypeCurrentRPC<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=感谢->感谢 !</h1></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="pinkhello",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&text=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&is_video=false&description=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&name=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6&description=RocketMQ%e5%bc%80%e7%ae%b1%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3-%e6%89%8b%e6%8f%a1%e5%a4%a7%e5%93%a5%e5%a4%a7" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f25-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-%25E9%2580%259A%25E4%25BF%25A1%25E7%25BB%2584%25E4%25BB%25B6%2f&t=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20%e9%80%9a%e4%bf%a1%e7%bb%84%e4%bb%b6" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 pinkhello</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>
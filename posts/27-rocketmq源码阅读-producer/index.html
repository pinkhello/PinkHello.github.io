<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>RocketMQ源码阅读 Producer | pinkhello</title><link rel=canonical href=https://pinkhello.cc/posts/27-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-producer/><meta name=description content="👷Hey! 我是 **pinkhello**，💻 一名后端程序员。**重要提示**: 在您阅读文章并评论之前，请先认真阅读[**评论承诺**](http://pinkhello.cc/promise)。"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="RocketMQ源码阅读 Producer"><meta property="og:description" content="RocketMQ开箱源码详解-Producer-我就是个打工人"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.cc/posts/27-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-producer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-07-23T15:10:37+08:00"><meta property="article:modified_time" content="2021-07-23T15:10:37+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="RocketMQ源码阅读 Producer"><meta name=twitter:description content="RocketMQ开箱源码详解-Producer-我就是个打工人"><link rel=stylesheet href=https://pinkhello.cc/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://pinkhello.cc/images/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-M2FXWC325L","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://pinkhello.cc/posts/26-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-nameserver/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://pinkhello.cc/posts/28-rocketmq%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB-consumer/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&text=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&is_video=false&description=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&name=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&description=RocketMQ%e5%bc%80%e7%ae%b1%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3-Producer-%e6%88%91%e5%b0%b1%e6%98%af%e4%b8%aa%e6%89%93%e5%b7%a5%e4%ba%ba" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&t=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">RocketMQ源码阅读 Producer</h1><div class=meta><div class=postdate><time datetime="2021-07-23 15:10:37 +0800 +0800" itemprop=datePublished>2021-07-23</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/tech>Tech</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/rocketmq rel=tag>RocketMQ</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#第一步>第一步</a></li><li><a href=#第二步-thisdefaultmqproducerimplstart>第二步 <code>this.defaultMQProducerImpl.start()</code>;</a></li><li><a href=#第三步-mqclientinstance-核心启动方法-mqclientfactorystart>第三步 MQClientInstance 核心启动方法 <code>mQClientFactory.start()</code>;</a></li></ul><ul><li><ul><li><a href=#defaultmqproducersend>DefaultMQProducer.send</a></li><li><a href=#defaultmqproducerimplsenddefaultimpl>DefaultMQProducerImpl.sendDefaultImpl</a></li><li><a href=#defaultmqproducerimplsendkernelimpl-这个方法是核心发送方法>DefaultMQProducerImpl.sendKernelImpl 这个方法是核心发送方法</a></li><li><a href=#mqclientapiimplsendmessage--和-mqclientapiimplsendmessagesync>MQClientAPIImpl.sendMessage 和 MQClientAPIImpl.sendMessageSync</a></li></ul></li></ul></nav></div><div class=content itemprop=articleBody><p>在消息发送的时候, 我们先看 <code>Producer</code> 的启动代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Producer</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        DefaultMQProducer producer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultMQProducer<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;ProducerGroupName&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        producer<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 128<span style=color:#f92672>;</span> i<span style=color:#f92672>++){</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                Message msg <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Message<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;TopicTest&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;TagA&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;OrderID188&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;Hello world&#34;</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getBytes</span><span style=color:#f92672>(</span>RemotingHelper<span style=color:#f92672>.</span><span style=color:#a6e22e>DEFAULT_CHARSET</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                SendResult sendResult <span style=color:#f92672>=</span> producer<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>printf</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;%s%n&#34;</span><span style=color:#f92672>,</span> sendResult<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>  
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        producer<span style=color:#f92672>.</span><span style=color:#a6e22e>shutdown</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>非常简单的代码构建了一个 <code>Producer</code>
下面肯定有疑问:</p><ul><li><code>Producer</code> 如何启动的</li><li><code>Producer</code> 发送消息流程</li><li><code>Producer</code> 和 <code>NameSever</code> 如何交互</li><li><code>Producer</code> 发送消息如何保证顺序</li><li><code>Producer</code> 负载均衡如何实现的</li><li><code>Producer</code> 延迟消息（发送的时候设置 <code>Message</code> 的延迟级别）</li></ul><h1 id=producer-端-如何启动的>Producer 端 如何启动的</h1><h2 id=第一步>第一步</h2><p>可以看到启动一个 <code>Producer</code> 的代码, 核心类 <code>DefaultMQProducer</code> ,构造方法中又 New 了一个新的类 <code>DefaultMQProducerImpl</code>, 这个类是给真正的核心的类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>DefaultMQProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String namespace<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String producerGroup<span style=color:#f92672>,</span> RPCHook rpcHook<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>namespace</span> <span style=color:#f92672>=</span> namespace<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>producerGroup</span> <span style=color:#f92672>=</span> producerGroup<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        defaultMQProducerImpl <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DefaultMQProducerImpl<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>,</span> rpcHook<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>后面入口走到 <code>start</code> 方法, 内部启动的 <code>defaultMQProducerImpl.start</code> 方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> MQClientException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//启动 Producer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>setProducerGroup</span><span style=color:#f92672>(</span>withNamespace<span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>producerGroup</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//真实的启动
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducerImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//.... 下面代码 省略 只看核心代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=第二步-thisdefaultmqproducerimplstart>第二步 <code>this.defaultMQProducerImpl.start()</code>;</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> startFactory<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//第一次 默认 new Producer 是 CreateJust 状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>case</span> CREATE_JUST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 完全启动后 置成 ServiceState.RUNNING
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>START_FAILED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//检查配置     group 是否填写、是不是默认的名字、长度是不是超出限制......
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>checkConfig</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//更改 instanceName 为 PID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>CLIENT_INNER_PRODUCER_GROUP</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>changeInstanceNameToPID</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 *   单例模式, 获取 MQClientInstance 对象, 客户端实例
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 *   MQClientManager JVM只有一个 静态常量
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 *   MQClientManager 内部维护着 clientId - MQClientInstance 的缓存 factoryTable
</span></span></span><span style=display:flex><span><span style=color:#75715e>                 */</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span> <span style=color:#f92672>=</span> MQClientManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getInstance</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getOrCreateMQClientInstance</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>,</span> rpcHook<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//将 Producer 注册到 Producer Group 中, 注册的 使用 producerTable 维护
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>///**
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// *  private final ConcurrentMap&lt;String,MQProducerInner &gt; producerTable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// *  = new ConcurrentHashMap&lt;String, MQProducerInner&gt;();
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// */
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>boolean</span> registerOK <span style=color:#f92672>=</span> mQClientFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>registerProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>registerOK<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>CREATE_JUST</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The producer group[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>()</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] has been created before, specify another name please.&#34;</span> <span style=color:#f92672>+</span> FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>suggestTodo</span><span style=color:#f92672>(</span>FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>GROUP_NAME_DUPLICATE_URL</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// 存储路由信息的对象  TopicPublishInfo 是路由信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// this.defaultMQProducer.getCreateTopicKey() 获取 message 中的 topic, 但是在此，还没那样 message 进入。看具体的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>// 是个默认的Key, 启动的时候为了测试和demo运行
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//     /**
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//     * Just for testing or demo program
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//     */
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//    private String createTopicKey = TopicValidator.AUTO_CREATE_TOPIC_KEY_TOPIC;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCreateTopicKey</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>new</span> TopicPublishInfo<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//启动生产
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>startFactory<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//MQClientInstance 的 start   真正的启动核心类
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    mQClientFactory<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;the producer [{}] start OK. sendMessageWithVIPChannel={}&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isSendMessageWithVIPChannel</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNNING</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> RUNNING<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> START_FAILED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> SHUTDOWN_ALREADY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The producer service state not OK, maybe started once, &#34;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>+</span> FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>suggestTodo</span><span style=color:#f92672>(</span>FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>CLIENT_SERVICE_NOT_OK</span><span style=color:#f92672>),</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//启动向所有的 broker 发送心态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendHeartbeatToAllBrokerWithLock</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 每隔 3 秒 扫描过期的请求
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>timer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>scheduleAtFixedRate</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TimerTask<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>run</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    RequestFutureTable<span style=color:#f92672>.</span><span style=color:#a6e22e>scanExpiredRequest</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Throwable e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;scan RequestFutureTable exception&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>},</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>,</span> 1000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>上述代码看注释</p><ul><li><ol><li><code>serviceState</code> 在 <code>new producer</code> 默认为 <code>CreateJust</code> 状态, 先设置为 <code>START_FAILE</code></li></ol></li><li><ol start=2><li><code>checkConfig</code> 检查配置, 看 <code>group</code> 是否填写, 是不是默认的名称, 长度是否超过限制</li></ol></li><li><ol start=3><li>更改 <code>InstanceName</code> 为 PID</li></ol></li><li><ol start=4><li>构建 <code>MQClientManager</code>（单例模式）提供获取 <code>MQClientInstance</code> 实例, 内部维护者一个 <code>ClientId</code> 和 <code>MQClientInstance</code> 的缓存</li></ol></li><li><ol start=5><li>注册 <code>Producer</code> 到 <code>ProducerGroup</code> 中 (线程安全的Map)</li></ol></li><li><ol start=6><li>存储路由信息的对象(<code>TopicPublishInfo</code>) 这边只是为了测试和demo程序</li></ol></li><li><ol start=7><li>后面启动真实的 <code>mQClientFactory.start()</code></li></ol></li><li><ol start=8><li>更改 <code>serviceState</code> 成 <code>RUNNING</code></li></ol></li><li><ol start=9><li>向所有的 <code>Broker</code> 发送心跳</li></ol></li><li>10.每隔 <code>3</code> 秒 扫描过期的请求</li></ul><h2 id=第三步-mqclientinstance-核心启动方法-mqclientfactorystart>第三步 MQClientInstance 核心启动方法 <code>mQClientFactory.start()</code>;</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>start</span><span style=color:#f92672>()</span> <span style=color:#66d9ef>throws</span> MQClientException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>synchronized</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> CREATE_JUST<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>START_FAILED</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// If not specified,looking address from name server
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 从 配置中找寻 NameServer 地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientConfig</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamesrvAddr</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>fetchNameServerAddr</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start request-response channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 开启 request-response 通道(代码上复用的通信组件 Netty 链接)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start various schedule tasks  | 开启 很多的定时任务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 定时任务有:
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 1. 每隔 2 分钟检测 NameServer 的变化
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 2. 每隔 30 秒从 NameServer 获取 Topic 路由信息变化 和 新的 Topic 路由信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 3. 每隔 30 秒清理 下线的 Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 4. 每隔 5 秒 持久化所有的消费进度
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 5. 每隔 1 分钟 检车线程池大小是否需要调整
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     */</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>startScheduledTask</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start pull service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 启动拉取消息的服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>pullMessageService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start rebalance service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>// 启动 Rebalance 负载均衡服务
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>rebalanceService</span><span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// Start push service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 这里又调用了 DefaultMQProducerImpl 的 start 方法, 因为传入的 false, 不会进入循环启动
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     * 未报错的话是为了先将 DefaultMQProducerImpl 实例内的状态机状态 先变更为 ServiceState.RUNNING
</span></span></span><span style=display:flex><span><span style=color:#75715e>                     */</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultMQProducerImpl</span><span style=color:#f92672>().</span><span style=color:#a6e22e>start</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>info</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;the client factory [{}] start OK&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>clientId</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//启动完毕, 变更状态
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>serviceState</span> <span style=color:#f92672>=</span> ServiceState<span style=color:#f92672>.</span><span style=color:#a6e22e>RUNNING</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>case</span> START_FAILED<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The Factory object[&#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientId</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] has been created before, and failed.&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>这边的代码主要是开启多个服务了</p><ul><li><ol><li>从 配置中找寻 <code>NameServer</code> 地址</li></ol></li><li><ol start=2><li>开启 <code>request response</code> 通道</li></ol></li><li><ol start=3><li>开启很多的定时任务</li></ol><ul><li>每隔 2 分钟检测 <code>NameServer</code> 的变化</li><li>每隔 30 秒从 <code>NameServer</code> 获取 <code>Topic</code> 路由信息变化 和 新的 <code>Topic</code> 路由信息</li><li>每隔 30 秒清理 下线的 Broker</li><li>每隔 5 秒 持久化所有的消费进度</li><li>每隔 1 分钟 检查线程池大小是否需要调整</li></ul></li><li><ol start=4><li>启动拉取消息的服务</li></ol></li><li><ol start=5><li>启动 <code>Rebalance</code> 负载均衡服务</li></ol></li><li><ol start=6><li><code>Start push service</code> 调用了 <code>DefaultMQProducerImpl.start</code></li></ol></li><li><ol start=7><li>启动完毕, 变更状态</li></ol></li></ul><h1 id=producer-发送消息流程>Producer 发送消息流程</h1><p>发送逻辑路径
<code>DefaultMQProducer.send</code>
->
<code>DefaultMQProducerImpl.send</code>
->
<code>DefaultMQProducerImpl.sendDefaultImpl</code>
->
<code>DefaultMQProducerImpl.sendKernelImpl</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>// 入口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> SendResult sendResult <span style=color:#f92672>=</span> producer<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span></code></pre></div><h3 id=defaultmqproducersend>DefaultMQProducer.send</h3><pre tabindex=0><code>        //  检查 msg 的 topic 基础信息( topic 名称不为空, topic 名称不包含非法字符, topic 名称长度&lt;127)
        @Override
        public SendResult send(
                Message msg) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
                //参数校验
                Validators.checkMessage(msg, this);
                //设置 topic
                msg.setTopic(withNamespace(msg.getTopic()));
                //发送消息
                return this.defaultMQProducerImpl.send(msg);
        }
</code></pre><h3 id=defaultmqproducerimplsenddefaultimpl>DefaultMQProducerImpl.sendDefaultImpl</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> SendResult <span style=color:#a6e22e>sendDefaultImpl</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> CommunicationMode communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendCallback sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeout
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//检查 Producer 状态OK
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>makeSureStateOK</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//检查 message 信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        Validators<span style=color:#f92672>.</span><span style=color:#a6e22e>checkMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> invokeID <span style=color:#f92672>=</span> random<span style=color:#f92672>.</span><span style=color:#a6e22e>nextLong</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//记录 开始时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> beginTimestampFirst <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//上此的开始时间默认为开始时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> beginTimestampPrev <span style=color:#f92672>=</span> beginTimestampFirst<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//结束时间默认为开始时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>long</span> endTimestamp <span style=color:#f92672>=</span> beginTimestampFirst<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//获取 Topic 对应的路由信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TopicPublishInfo topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tryToFindTopicPublishInfo</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicPublishInfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>boolean</span> callTimeout <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            MessageQueue mq <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            Exception exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            SendResult sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//根据模式, 同步 还是 异步, 决定发送失败的重试的总次数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>int</span> timesTotal <span style=color:#f92672>=</span> communicationMode <span style=color:#f92672>==</span> CommunicationMode<span style=color:#f92672>.</span><span style=color:#a6e22e>SYNC</span> <span style=color:#f92672>?</span> 1 <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRetryTimesWhenSendFailed</span><span style=color:#f92672>()</span> <span style=color:#f92672>:</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> times <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> brokersSent <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> String<span style=color:#f92672>[</span>timesTotal<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//循环发送, 成功发送的跳出循环
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(;</span> times <span style=color:#f92672>&lt;</span> timesTotal<span style=color:#f92672>;</span> times<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String lastBrokerName <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> mq <span style=color:#f92672>?</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>:</span> mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//选择合适的队列  核心的方法( 开启 容错策略的话的核心方法)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                MessageQueue mqSelected <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span>topicPublishInfo<span style=color:#f92672>,</span> lastBrokerName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//队列不为空进行发送
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>mqSelected <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    mq <span style=color:#f92672>=</span> mqSelected<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    brokersSent<span style=color:#f92672>[</span>times<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//记录上次的开始时间
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        beginTimestampPrev <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>times <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>//Reset topic with namespace during resend.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>withNamespace</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//发送已经耗费的总时间, 如果在规定的时间内, 还没有发送成功, 跳出重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>long</span> costTime <span style=color:#f92672>=</span> beginTimestampPrev <span style=color:#f92672>-</span> beginTimestampFirst<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeout <span style=color:#f92672>&lt;</span> costTime<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            callTimeout <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//发送
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendKernelImpl</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> mq<span style=color:#f92672>,</span> communicationMode<span style=color:#f92672>,</span> sendCallback<span style=color:#f92672>,</span> topicPublishInfo<span style=color:#f92672>,</span> timeout <span style=color:#f92672>-</span> costTime<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//根据发送耗费的时间决定是不是要将该 Broker 加入到故障列表缓存中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//根据模式决定做什么动作
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//异步 什么都不做
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ONEWAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//oneway 什么都不做
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> SYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//同步发送 根据发送返回状态决定是否重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendResult<span style=color:#f92672>.</span><span style=color:#a6e22e>getSendStatus</span><span style=color:#f92672>()</span> <span style=color:#f92672>!=</span> SendStatus<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_OK</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isRetryAnotherBrokerWhenNotStoreOK</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                                <span style=color:#75715e>//发送成功直接结束方法
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                                <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemotingException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//出现异常加入故障列表, 进行重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        exception <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MQClientException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//出现异常加入故障列表, 进行重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        exception <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MQBrokerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//出现异常加入故障列表, 进行重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, resend at once, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        exception <span style=color:#f92672>=</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>e<span style=color:#f92672>.</span><span style=color:#a6e22e>getResponseCode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>TOPIC_NOT_EXIST</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SERVICE_NOT_AVAILABLE</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SYSTEM_ERROR</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_PERMISSION</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>NO_BUYER_ID</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>NOT_IN_CURRENT_UNIT</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>continue</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendResult <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                    <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//出现异常加入故障列表, 进行重试
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        endTimestamp <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateFaultItem</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception, throw exception, InvokeID: %s, RT: %sms, Broker: %s&#34;</span><span style=color:#f92672>,</span> invokeID<span style=color:#f92672>,</span> endTimestamp <span style=color:#f92672>-</span> beginTimestampPrev<span style=color:#f92672>,</span> mq<span style=color:#f92672>),</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl exception&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendResult <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            String info <span style=color:#f92672>=</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>format</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Send [%d] times, still failed, cost [%d]ms, Topic: %s, BrokersSent: %s&#34;</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                times<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginTimestampFirst<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                Arrays<span style=color:#f92672>.</span><span style=color:#a6e22e>toString</span><span style=color:#f92672>(</span>brokersSent<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            info <span style=color:#f92672>+=</span> FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>suggestTodo</span><span style=color:#f92672>(</span>FAQUrl<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_MSG_FAILED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            MQClientException mqClientException <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span>info<span style=color:#f92672>,</span> exception<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>callTimeout<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendDefaultImpl call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> MQBrokerException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(((</span>MQBrokerException<span style=color:#f92672>)</span> exception<span style=color:#f92672>).</span><span style=color:#a6e22e>getResponseCode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> RemotingConnectException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(</span>ClientErrorCode<span style=color:#f92672>.</span><span style=color:#a6e22e>CONNECT_BROKER_EXCEPTION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> RemotingTimeoutException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(</span>ClientErrorCode<span style=color:#f92672>.</span><span style=color:#a6e22e>ACCESS_BROKER_TIMEOUT</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>exception <span style=color:#66d9ef>instanceof</span> MQClientException<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                mqClientException<span style=color:#f92672>.</span><span style=color:#a6e22e>setResponseCode</span><span style=color:#f92672>(</span>ClientErrorCode<span style=color:#f92672>.</span><span style=color:#a6e22e>BROKER_NOT_EXIST_EXCEPTION</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> mqClientException<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//.... 下面代码 省略 只看核心代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=defaultmqproducerimplsendkernelimpl-这个方法是核心发送方法>DefaultMQProducerImpl.sendKernelImpl 这个方法是核心发送方法</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> SendResult <span style=color:#a6e22e>sendKernelImpl</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> MessageQueue mq<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> CommunicationMode communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendCallback sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> TopicPublishInfo topicPublishInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeout<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> beginStartTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//找寻broker地址
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        String brokerAddr <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>findBrokerAddressInPublish</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> brokerAddr<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            tryToFindTopicPublishInfo<span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            brokerAddr <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>findBrokerAddressInPublish</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        SendMessageContext context <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>brokerAddr <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            brokerAddr <span style=color:#f92672>=</span> MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>brokerVIPChannel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isSendMessageWithVIPChannel</span><span style=color:#f92672>(),</span> brokerAddr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> prevBody <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//for MessageBatch,ID has been set in the generating process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!(</span>msg <span style=color:#66d9ef>instanceof</span> MessageBatch<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    MessageClientIDSetter<span style=color:#f92672>.</span><span style=color:#a6e22e>setUniqID</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>boolean</span> topicWithNamespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientConfig</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setInstanceId</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientConfig</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    topicWithNamespace <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> sysFlag <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>boolean</span> msgBodyCompressed <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>tryToCompressMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sysFlag <span style=color:#f92672>|=</span> MessageSysFlag<span style=color:#f92672>.</span><span style=color:#a6e22e>COMPRESSED_FLAG</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    msgBodyCompressed <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> String tranMsg <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_TRANSACTION_PREPARED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>tranMsg <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> Boolean<span style=color:#f92672>.</span><span style=color:#a6e22e>parseBoolean</span><span style=color:#f92672>(</span>tranMsg<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    sysFlag <span style=color:#f92672>|=</span> MessageSysFlag<span style=color:#f92672>.</span><span style=color:#a6e22e>TRANSACTION_PREPARED_TYPE</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>hasCheckForbiddenHook<span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    CheckForbiddenContext checkForbiddenContext <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CheckForbiddenContext<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setNameSrvAddr</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamesrvAddr</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setGroup</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setCommunicationMode</span><span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setBrokerAddr</span><span style=color:#f92672>(</span>brokerAddr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setMq</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    checkForbiddenContext<span style=color:#f92672>.</span><span style=color:#a6e22e>setUnitMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isUnitMode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeCheckForbiddenHook</span><span style=color:#f92672>(</span>checkForbiddenContext<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SendMessageContext<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setProducer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setProducerGroup</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setCommunicationMode</span><span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setBornHost</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getClientIP</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setBrokerAddr</span><span style=color:#f92672>(</span>brokerAddr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMq</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setNamespace</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    String isTrans <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_TRANSACTION_PREPARED</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isTrans <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isTrans<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMsgType</span><span style=color:#f92672>(</span>MessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>Trans_Msg_Half</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;__STARTDELIVERTIME&#34;</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_DELAY_TIME_LEVEL</span><span style=color:#f92672>)</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        context<span style=color:#f92672>.</span><span style=color:#a6e22e>setMsgType</span><span style=color:#f92672>(</span>MessageType<span style=color:#f92672>.</span><span style=color:#a6e22e>Delay_Msg</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookBefore</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                SendMessageRequestHeader requestHeader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> SendMessageRequestHeader<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setProducerGroup</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getProducerGroup</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultTopic</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getCreateTopicKey</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setDefaultTopicQueueNums</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultTopicQueueNums</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setQueueId</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueueId</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setSysFlag</span><span style=color:#f92672>(</span>sysFlag<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setBornTimestamp</span><span style=color:#f92672>(</span>System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setFlag</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getFlag</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setProperties</span><span style=color:#f92672>(</span>MessageDecoder<span style=color:#f92672>.</span><span style=color:#a6e22e>messageProperties2String</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperties</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setReconsumeTimes</span><span style=color:#f92672>(</span>0<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setUnitMode</span><span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>isUnitMode</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setBatch</span><span style=color:#f92672>(</span>msg <span style=color:#66d9ef>instanceof</span> MessageBatch<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>().</span><span style=color:#a6e22e>startsWith</span><span style=color:#f92672>(</span>MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>RETRY_GROUP_TOPIC_PREFIX</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    String reconsumeTimes <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>getReconsumeTime</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>reconsumeTimes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setReconsumeTimes</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>reconsumeTimes<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                        MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>clearProperty</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_RECONSUME_TIME</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    String maxReconsumeTimes <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>getMaxReconsumeTimes</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>maxReconsumeTimes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setMaxReconsumeTimes</span><span style=color:#f92672>(</span>Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>maxReconsumeTimes<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>                        MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>clearProperty</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_MAX_RECONSUME_TIMES</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                SendResult sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        Message tmpMessage <span style=color:#f92672>=</span> msg<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>boolean</span> messageCloned <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>msgBodyCompressed<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#75715e>//If msg body was compressed, msgbody should be reset using prevBody.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>//Clone new message using commpressed message body and recover origin massage.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            <span style=color:#75715e>//Fix bug:https://github.com/apache/rocketmq-externals/issues/66
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                            tmpMessage <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>cloneMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                            messageCloned <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>prevBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicWithNamespace<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>messageCloned<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                                tmpMessage <span style=color:#f92672>=</span> MessageAccessor<span style=color:#f92672>.</span><span style=color:#a6e22e>cloneMessage</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                                messageCloned <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                            msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>NamespaceUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>withoutNamespace</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>long</span> costTimeAsync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeout <span style=color:#f92672>&lt;</span> costTimeAsync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        <span style=color:#75715e>//真正的核心发送方法 是 rocketMQ 通用的网络层工具在签名介绍过
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                        sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMQClientAPIImpl</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                            brokerAddr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                            tmpMessage<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            requestHeader<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            timeout <span style=color:#f92672>-</span> costTimeAsync<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            topicPublishInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getRetryTimesWhenSendAsyncFailed</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                            context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> ONEWAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>case</span> SYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>long</span> costTimeSync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeout <span style=color:#f92672>&lt;</span> costTimeSync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendKernelImpl call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                        sendResult <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getMQClientAPIImpl</span><span style=color:#f92672>().</span><span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>                            brokerAddr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>(),</span>
</span></span><span style=display:flex><span>                            msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            requestHeader<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            timeout <span style=color:#f92672>-</span> costTimeSync<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>this</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>assert</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setSendResult</span><span style=color:#f92672>(</span>sendResult<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> sendResult<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>RemotingException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setException</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>MQBrokerException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setException</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>hasSendMessageHook</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    context<span style=color:#f92672>.</span><span style=color:#a6e22e>setException</span><span style=color:#f92672>(</span>e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>executeSendMessageHookAfter</span><span style=color:#f92672>(</span>context<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>throw</span> e<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>prevBody<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>NamespaceUtil<span style=color:#f92672>.</span><span style=color:#a6e22e>withoutNamespace</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getNamespace</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;The broker[&#34;</span> <span style=color:#f92672>+</span> mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] not exist&#34;</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=mqclientapiimplsendmessage--和-mqclientapiimplsendmessagesync>MQClientAPIImpl.sendMessage 和 MQClientAPIImpl.sendMessageSync</h3><p>可以发现 下面的发送 <code>MQClientAPIImpl.sendMessage</code> -> <code>MQClientAPIImpl.sendMessageSync</code>
，最后委托给 <code>netty</code> 的，当然在里面还有 如何实现 <code>Async</code> 、<code>Sync</code>、<code>Oneway</code> 发送的，想深究的话可以具体深入.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SendResult <span style=color:#a6e22e>sendMessage</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String addr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String brokerName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendMessageRequestHeader requestHeader<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> CommunicationMode communicationMode<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendCallback sendCallback<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> TopicPublishInfo topicPublishInfo<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> MQClientInstance instance<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>int</span> retryTimesWhenSendFailed<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> SendMessageContext context<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> DefaultMQProducerImpl producer
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>long</span> beginStartTime <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        RemotingCommand request <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        String msgType <span style=color:#f92672>=</span> msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_MESSAGE_TYPE</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isReply <span style=color:#f92672>=</span> msgType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> msgType<span style=color:#f92672>.</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>MixAll<span style=color:#f92672>.</span><span style=color:#a6e22e>REPLY_MESSAGE_FLAG</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isReply<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendSmartMsg<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                SendMessageRequestHeaderV2 requestHeaderV2 <span style=color:#f92672>=</span> SendMessageRequestHeaderV2<span style=color:#f92672>.</span><span style=color:#a6e22e>createSendMessageRequestHeaderV2</span><span style=color:#f92672>(</span>requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_REPLY_MESSAGE_V2</span><span style=color:#f92672>,</span> requestHeaderV2<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_REPLY_MESSAGE</span><span style=color:#f92672>,</span> requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>sendSmartMsg <span style=color:#f92672>||</span> msg <span style=color:#66d9ef>instanceof</span> MessageBatch<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                SendMessageRequestHeaderV2 requestHeaderV2 <span style=color:#f92672>=</span> SendMessageRequestHeaderV2<span style=color:#f92672>.</span><span style=color:#a6e22e>createSendMessageRequestHeaderV2</span><span style=color:#f92672>(</span>requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>msg <span style=color:#66d9ef>instanceof</span> MessageBatch <span style=color:#f92672>?</span> RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_BATCH_MESSAGE</span> <span style=color:#f92672>:</span> RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_MESSAGE_V2</span><span style=color:#f92672>,</span> requestHeaderV2<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SEND_MESSAGE</span><span style=color:#f92672>,</span> requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        request<span style=color:#f92672>.</span><span style=color:#a6e22e>setBody</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>communicationMode<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ONEWAY<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remotingClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeOneway</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> timeoutMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ASYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>final</span> AtomicInteger times <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> AtomicInteger<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>long</span> costTimeAsync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeoutMillis <span style=color:#f92672>&lt;</span> costTimeAsync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendMessage call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessageAsync</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> brokerName<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> timeoutMillis <span style=color:#f92672>-</span> costTimeAsync<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> sendCallback<span style=color:#f92672>,</span> topicPublishInfo<span style=color:#f92672>,</span> instance<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>                    retryTimesWhenSendFailed<span style=color:#f92672>,</span> times<span style=color:#f92672>,</span> context<span style=color:#f92672>,</span> producer<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> SYNC<span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>long</span> costTimeSync <span style=color:#f92672>=</span> System<span style=color:#f92672>.</span><span style=color:#a6e22e>currentTimeMillis</span><span style=color:#f92672>()</span> <span style=color:#f92672>-</span> beginStartTime<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>timeoutMillis <span style=color:#f92672>&lt;</span> costTimeSync<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RemotingTooMuchRequestException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;sendMessage call timeout&#34;</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendMessageSync</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> brokerName<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> timeoutMillis <span style=color:#f92672>-</span> costTimeSync<span style=color:#f92672>,</span> request<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>assert</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> SendResult <span style=color:#a6e22e>sendMessageSync</span><span style=color:#f92672>(</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String addr<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> String brokerName<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>final</span> RemotingCommand request
</span></span><span style=display:flex><span>    <span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        RemotingCommand response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remotingClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeSync</span><span style=color:#f92672>(</span>addr<span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> timeoutMillis<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>processSendResponse</span><span style=color:#f92672>(</span>brokerName<span style=color:#f92672>,</span> msg<span style=color:#f92672>,</span> response<span style=color:#f92672>,</span>addr<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-和-namesever-如何交互>Producer 和 NameSever 如何交互</h1><ul><li>在 <code>Producer</code> 启动 和 发送消息的 代码走读的时候，应该留意了 <code>TopicPublishInfo</code> 这个类</li></ul><p><code>DefaultMQProducerImpl.sendDefaultImpl</code>
->
<code>DefaultMQProducerImpl.tryToFindTopicPublishInfo</code>
->
<code>MQClientInstance.updateTopicRouteInfoFromNameServer</code>
->
<code>MQClientAPIImpl.getTopicRouteInfoFromNameServer</code></p><p>看到先从缓存获取路由信息，发现没有的话 再从 <code>NameServer</code> 获取(<code>this.mQClientFactory.updateTopicRouteInfoFromNameServer(topic);</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>     <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 获取 topic 对应的路由信息
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param topic
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> TopicPublishInfo <span style=color:#a6e22e>tryToFindTopicPublishInfo</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String topic<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//从缓存中获取路由信息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TopicPublishInfo topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//如果本地缓存的路由信息无 或者 不是将康的
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>null</span> <span style=color:#f92672>==</span> topicPublishInfo <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>putIfAbsent</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>new</span> TopicPublishInfo<span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//从 NameServer 获取 Topic信息进行更新更新到本地缓存中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>isHaveTopicRouterInfo</span><span style=color:#f92672>()</span> <span style=color:#f92672>||</span> topicPublishInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>ok</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> topicPublishInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//从 NameServer 获取 Topic信息进行更新更新到本地缓存中
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientFactory</span><span style=color:#f92672>.</span><span style=color:#a6e22e>updateTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducer</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            topicPublishInfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>topicPublishInfoTable</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> topicPublishInfo<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//.... 上面代码 省略 只看核心代码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TopicRouteData topicRouteData<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>isDefault <span style=color:#f92672>&amp;&amp;</span> defaultMQProducer <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            topicRouteData <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>defaultMQProducer<span style=color:#f92672>.</span><span style=color:#a6e22e>getCreateTopicKey</span><span style=color:#f92672>(),</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>topicRouteData <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>QueueData data <span style=color:#f92672>:</span> topicRouteData<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueueDatas</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> queueNums <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>min</span><span style=color:#f92672>(</span>defaultMQProducer<span style=color:#f92672>.</span><span style=color:#a6e22e>getDefaultTopicQueueNums</span><span style=color:#f92672>(),</span> data<span style=color:#f92672>.</span><span style=color:#a6e22e>getReadQueueNums</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>                    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setReadQueueNums</span><span style=color:#f92672>(</span>queueNums<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    data<span style=color:#f92672>.</span><span style=color:#a6e22e>setWriteQueueNums</span><span style=color:#f92672>(</span>queueNums<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            topicRouteData <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>mQClientAPIImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> 1000 <span style=color:#f92672>*</span> 3<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//.... 下面代码 省略 只看核心代码
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> TopicRouteData <span style=color:#a6e22e>getTopicRouteInfoFromNameServer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>long</span> timeoutMillis<span style=color:#f92672>,</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> allowTopicNotExist<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> InterruptedException<span style=color:#f92672>,</span> RemotingTimeoutException<span style=color:#f92672>,</span> RemotingSendRequestException<span style=color:#f92672>,</span> RemotingConnectException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        GetRouteInfoRequestHeader requestHeader <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> GetRouteInfoRequestHeader<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        requestHeader<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//构建向 NameServer 发送的消息体
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RemotingCommand request <span style=color:#f92672>=</span> RemotingCommand<span style=color:#f92672>.</span><span style=color:#a6e22e>createRequestCommand</span><span style=color:#f92672>(</span>RequestCode<span style=color:#f92672>.</span><span style=color:#a6e22e>GET_ROUTEINFO_BY_TOPIC</span><span style=color:#f92672>,</span> requestHeader<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>//开始发送请求并且是同步的方式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        RemotingCommand response <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>remotingClient</span><span style=color:#f92672>.</span><span style=color:#a6e22e>invokeSync</span><span style=color:#f92672>(</span><span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> request<span style=color:#f92672>,</span> timeoutMillis<span style=color:#f92672>);</span><span style=color:#66d9ef>assert</span> response <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>assert</span> response <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> <span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>())</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>TOPIC_NOT_EXIST</span><span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>allowTopicNotExist<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    log<span style=color:#f92672>.</span><span style=color:#a6e22e>warn</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;get Topic [{}] RouteInfoFromNameServer is not exist value&#34;</span><span style=color:#f92672>,</span> topic<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> ResponseCode<span style=color:#f92672>.</span><span style=color:#a6e22e>SUCCESS</span><span style=color:#f92672>:</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> body <span style=color:#f92672>=</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getBody</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>body <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> TopicRouteData<span style=color:#f92672>.</span><span style=color:#a6e22e>decode</span><span style=color:#f92672>(</span>body<span style=color:#f92672>,</span> TopicRouteData<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> MQClientException<span style=color:#f92672>(</span>response<span style=color:#f92672>.</span><span style=color:#a6e22e>getCode</span><span style=color:#f92672>(),</span> response<span style=color:#f92672>.</span><span style=color:#a6e22e>getRemark</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-发送消息如何保证顺序>Producer 发送消息如何保证顺序</h1><p><code>RocketMQ</code> 发送的消息支持是有序的，消费消息的顺序和发送消息的顺序一致的。当然 <code>Producer</code> 发送的消息要有序，是局部消息有序，要保证发送到同一个Topic下的同一个Queue，这样 <code>Consumer</code> 可以按照 <code>Producer</code> 发送的消息顺序进行消费。</p><ul><li>普通顺序消息</li></ul><blockquote><p>正常情况下保证完全的顺序消息, 但是如果发生通讯异常(Broker重启等),由于队列的总数发送变化。哈希取模后定位的队列也会发生变化，产生的消息可能短暂的消息顺序不一致。</p></blockquote><ul><li>严格顺序消息</li></ul><blockquote><p>无论正常异常情况都保证顺序一致, 但是牺牲了分布式的 Failover 特性（Broker集群只要有一台不可用，整个集群都不可用, 服务可用性大大降低）
要保证严格的顺序消息，需要保证 Producer -> MQServer -> Consumer 都是一对一的关系</p></blockquote><p>在 Producer 端保证发送顺序的一致性的是通过保证 顺序消息把同类型的消息发送到同一个 <code>MessageQueue</code> 实现的。核心代码在从 <code>send</code> 方法入手
<code>Producer.send </code>有个重载的方法 <code>send(Message msg, MessageQueueSelector selector, Object arg)</code>, 参数为 <code>MessageQueueSelector</code> selector , 只要实现这个接口，可以通过</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> SendResult <span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>Message msg<span style=color:#f92672>,</span> MessageQueueSelector selector<span style=color:#f92672>,</span> Object arg<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throws</span> MQClientException<span style=color:#f92672>,</span> RemotingException<span style=color:#f92672>,</span> MQBrokerException<span style=color:#f92672>,</span> InterruptedException <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        msg<span style=color:#f92672>.</span><span style=color:#a6e22e>setTopic</span><span style=color:#f92672>(</span>withNamespace<span style=color:#f92672>(</span>msg<span style=color:#f92672>.</span><span style=color:#a6e22e>getTopic</span><span style=color:#f92672>()));</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>defaultMQProducerImpl</span><span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span>msg<span style=color:#f92672>,</span> selector<span style=color:#f92672>,</span> arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>MessageQueueSelector</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    MessageQueue <span style=color:#a6e22e>select</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> List<span style=color:#f92672>&lt;</span>MessageQueue<span style=color:#f92672>&gt;</span> mqs<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Message msg<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> Object arg<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-负载均衡如何实现的>Producer 负载均衡如何实现的</h1><p><code>DefaultMQProducerImpl.send</code>
-> <code>DefaultMQProducerImpl.sendDefaultImpl</code>
—> <code>DefaultMQProducerImpl.selectOneMessageQueue</code>
-> <code>MQFaultStrategy.selectOneMessageQueue</code> (这边是 是否开启容错策略，即负载均衡策略在内部)
-> <code>TopicPublishInfo.selectOneMessageQueue</code></p><p>下面在选择低延迟的 Broker，根据 faultItem 的可用性和开始时间选择的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 在 rocketMQ 中 一个 Topic 包含多个 MessageQueue, 分散在不同的 Broker。
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * 一个 Producer 发送消息的时候顺序是这样的
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 1. Producer 获取消息路由信息( 当本地缓存无路由信息时候、从 NameSrv 获取路由信息 )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 2. Producer 发送消息到 Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 3. Broker 存储发送的消息  ( 根据不同 Broker 配置, 可同步或异步存储发送消息 )
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 4. Broker 向 Producer 反馈的发送消息的结果
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  在这个发送过程中可能存在发送失败
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  队列的选择和容错策略
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 在不开启容错下, 轮询队列进行发送, 如果失败了, 重试的时候过滤失败的 Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 如果开启了容错, 会通过 RocketMQ 的预测机制来预测一个 Broker 是否可用
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 如果上次失败的 Broker 可用, 那么还继续选择该 Broker 队列
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 如果上述失败, 则随机选择一个 Broker 进行发送
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  - 在发送消息的时候会记录一下调用的时间与发送是否错误，根据时间去预测 故障的Broker 可用时间
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param tpInfo
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @param lastBrokerName
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * @return
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MessageQueue <span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> TopicPublishInfo tpInfo<span style=color:#f92672>,</span> <span style=color:#66d9ef>final</span> String lastBrokerName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 是否开启容错策略
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendLatencyFaultEnable</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//选择一个队列, topicInfo ThreadLocalIndex 都 + 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getSendWhichQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//与队列的长度取模, 根据最后的 pos 取一个队列
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessageQueueList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>int</span> pos <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>abs</span><span style=color:#f92672>(</span>index<span style=color:#f92672>++)</span> <span style=color:#f92672>%</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessageQueueList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pos <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                        pos <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                    MessageQueue mq <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getMessageQueueList</span><span style=color:#f92672>().</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>pos<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//判断获取到的队列的Broker 是否在故障列表中, 非故障的则返回
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>latencyFaultTolerance<span style=color:#f92672>.</span><span style=color:#a6e22e>isAvailable</span><span style=color:#f92672>(</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>()))</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>return</span> mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//代码走到这边, 说明没有非故障的队列 只能从故障列表中获取一个队列
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#75715e>//如果这个 topic 下的所有的队列都是故障的话, 那么就从故障列表中取出一个 Broker
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>final</span> String notBestBroker <span style=color:#f92672>=</span> latencyFaultTolerance<span style=color:#f92672>.</span><span style=color:#a6e22e>pickOneAtLeast</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>//获取这个 Broker 的可写队列数, 如果该 Broker 没有可写的队列, 则返回 -1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                <span style=color:#66d9ef>int</span> writeQueueNums <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getQueueIdByBroker</span><span style=color:#f92672>(</span>notBestBroker<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>writeQueueNums <span style=color:#f92672>&gt;</span> 0<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>// 选择队列, 通过与队列的长度取模确定队列的位置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>final</span> MessageQueue mq <span style=color:#f92672>=</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>notBestBroker <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                        mq<span style=color:#f92672>.</span><span style=color:#a6e22e>setBrokerName</span><span style=color:#f92672>(</span>notBestBroker<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                        mq<span style=color:#f92672>.</span><span style=color:#a6e22e>setQueueId</span><span style=color:#f92672>(</span>tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>getSendWhichQueue</span><span style=color:#f92672>().</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>()</span> <span style=color:#f92672>%</span> writeQueueNums<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#75715e>//没有可写的队列,直接从故障列表中移除
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    latencyFaultTolerance<span style=color:#f92672>.</span><span style=color:#a6e22e>remove</span><span style=color:#f92672>(</span>notBestBroker<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                log<span style=color:#f92672>.</span><span style=color:#a6e22e>error</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Error occurred when selecting message queue&#34;</span><span style=color:#f92672>,</span> e<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>//如果故障列表中没有可写的队列, 直接从Topic Publish Info中取一个
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 如果没有开启故障延迟, 直接从 Topic Publish Info 通过取模的方式获取队列,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 如果LastBrokerName不为空，则需要过滤掉brokerName=lastBrokerName的队列
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// 没有开启故障延迟的话，走轮询模式
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> tpInfo<span style=color:#f92672>.</span><span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span>lastBrokerName<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>核心在下述方法中，TopicPublishInfo.selectOneMessageQueue</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     *  轮询模式
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> MessageQueue <span style=color:#a6e22e>selectOneMessageQueue</span><span style=color:#f92672>(</span><span style=color:#66d9ef>final</span> String lastBrokerName<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>lastBrokerName <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> selectOneMessageQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>messageQueueList</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span> i<span style=color:#f92672>++)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> index <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>sendWhichQueue</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getAndIncrement</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> pos <span style=color:#f92672>=</span> Math<span style=color:#f92672>.</span><span style=color:#a6e22e>abs</span><span style=color:#f92672>(</span>index<span style=color:#f92672>)</span> <span style=color:#f92672>%</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>messageQueueList</span><span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>pos <span style=color:#f92672>&lt;</span> 0<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>                    pos <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                MessageQueue mq <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>messageQueueList</span><span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>pos<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>mq<span style=color:#f92672>.</span><span style=color:#a6e22e>getBrokerName</span><span style=color:#f92672>().</span><span style=color:#a6e22e>equals</span><span style=color:#f92672>(</span>lastBrokerName<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> mq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> selectOneMessageQueue<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h1 id=producer-延迟消息发送的时候设置message的延迟级别>Producer 延迟消息（发送的时候设置Message的延迟级别）</h1><p>延迟消息</p><blockquote><p>消息发送到 <code>Broker</code>, 不能立刻被 <code>Consumer</code> 消费，只有到了特定的时间点或者等待特定的时间后，才能被消费。</p></blockquote><p>延迟消息两种类型</p><ul><li>定时消息 （特定的时间 <code>level</code>）</li><li>任意的时间精度的延迟消息</li></ul><p><code>RocketMQ</code> 不支持 任意时间度的延迟消息, 因为如果需要支持，在<code>Broker</code>层面需要做大量的消息排序，还需要持久化，那么会产生巨大的性能开销。
所以 <code>RocketMQ</code> 只支持 定时消息。</p><p>回头看 <code>Message#setDelayTimeLevel</code>方法</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>     <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>setDelayTimeLevel</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> level<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>putProperty</span><span style=color:#f92672>(</span>MessageConst<span style=color:#f92672>.</span><span style=color:#a6e22e>PROPERTY_DELAY_TIME_LEVEL</span><span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>level<span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="pinkhello",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&text=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&is_video=false&description=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&title=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&name=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer&description=RocketMQ%e5%bc%80%e7%ae%b1%e6%ba%90%e7%a0%81%e8%af%a6%e8%a7%a3-Producer-%e6%88%91%e5%b0%b1%e6%98%af%e4%b8%aa%e6%89%93%e5%b7%a5%e4%ba%ba" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f27-rocketmq%25E6%25BA%2590%25E7%25A0%2581%25E9%2598%2585%25E8%25AF%25BB-producer%2f&t=RocketMQ%e6%ba%90%e7%a0%81%e9%98%85%e8%af%bb%20Producer" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 pinkhello</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>
<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>如何去实现RingBuffer | pinkhello</title><link rel=canonical href=https://pinkhello.cc/posts/45-%E5%A6%82%E4%BD%95%E5%8E%BB%E5%AE%9E%E7%8E%B0ringbuffer/><meta name=description content="👷Hey! 我是 **pinkhello**，💻 一名后端程序员。**重要提示**: 在您阅读文章并评论之前，请先认真阅读[**评论承诺**](http://pinkhello.cc/promise)。"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="如何去实现RingBuffer"><meta property="og:description" content="如何去实现RingBuffer"><meta property="og:type" content="article"><meta property="og:url" content="https://pinkhello.cc/posts/45-%E5%A6%82%E4%BD%95%E5%8E%BB%E5%AE%9E%E7%8E%B0ringbuffer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-10T14:39:59+08:00"><meta property="article:modified_time" content="2022-02-10T14:39:59+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="如何去实现RingBuffer"><meta name=twitter:description content="如何去实现RingBuffer"><link rel=stylesheet href=https://pinkhello.cc/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://pinkhello.cc/css/pinkhello.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://pinkhello.cc/images/favicon.ico><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga('create','G-M2FXWC325L','auto'),ga('send','pageview'))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick="$('html, body').animate({scrollTop:0},'fast')" style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://pinkhello.cc/posts/43-golang%E7%9A%84%E6%B1%A0%E5%8C%96%E8%AE%BE%E8%AE%A1/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover="$('#i-prev').toggle()" onmouseout="$('#i-prev').toggle()"></i></a></li><li><a class=icon href=https://pinkhello.cc/posts/46-lrucache-%E5%AE%9E%E7%8E%B0/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover="$('#i-next').toggle()" onmouseout="$('#i-next').toggle()"></i></a></li><li><a class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover="$('#i-top').toggle()" onmouseout="$('#i-top').toggle()"></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover="$('#i-share').toggle()" onmouseout="$('#i-share').toggle()" onclick="return $('#share').toggle(),!1"></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&text=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&is_video=false&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&name=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&t=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">如何去实现RingBuffer</h1><div class=meta><div class=postdate><time datetime="2022-02-10 14:39:59 +0800 +0800" itemprop=datePublished>2022-02-10</time></div><div class=article-category><i class="fas fa-archive"></i>
<a class=category-link href=/categories/tech>Tech</a></div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/algorithms rel=tag>Algorithms</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#实现它的方式>实现它的方式</a></li><li><a href=#讨论-ringbuffer-的运行方式>讨论 ringbuffer 的运行方式</a></li><li><a href=#empty-buffer-和-full-buffer>Empty Buffer 和 Full Buffer</a><ul><li><a href=#empty-buffer-判定>Empty Buffer 判定</a></li><li><a href=#full-buffer-判定>Full Buffer 判定</a></li></ul></li></ul><ul><li><a href=#定义>定义</a></li><li><a href=#offer-插入>offer 插入</a></li><li><a href=#poll-读取>poll 读取</a></li><li><a href=#ut>UT</a></li><li><a href=#线程安全的>线程安全的</a></li></ul></nav></div><div class=content itemprop=articleBody><h1 id=文引>文引</h1><p><code>RingBuffer</code>, 名如其意: <code>环形缓存区</code>/<code>环形队列</code>，不同于一般的队列，特征是首尾相接。</p><h1 id=ringbuffer-如何工作的><code>RingBuffer</code> 如何工作的</h1><p><code>RingBuffer</code> 是一个有界的循环的数据结构，主要用于多线程下进行的数据缓存。在持续的写入数据的时候，到达末尾的时候链接到头，效果上达成一个环状。</p><h2 id=实现它的方式>实现它的方式</h2><p>它是有界的数组实现，如图。</p><p><img src=/ringbuffer/%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0ringbuffer.png alt=ringbuffer数组实现></p><p>而且我们还要关注到 <code>reader指针</code> 、 <code>writer指针</code>、 头尾相连</p><ul><li><code>reader pointer</code> 下一个可读元素</li><li><code>writer pointer</code> 下一个可插入的元素 <code>slot</code></li><li>数组头 和 数组尾 相互链接</li></ul><h2 id=讨论-ringbuffer-的运行方式>讨论 ringbuffer 的运行方式</h2><p><code>ringbuffer</code> 的关键参数, <code>read seq</code> & <code>write seq</code></p><ul><li><code>reader pointer seq</code> => 从 <code>0</code> 开始，随着读取消耗一个元素 <code>+1</code></li><li><code>writer pointer seq</code> => 从 <code>-1</code> 开始，插入一个元素时候 <code>+1</code></li></ul><p><img src=/ringbuffer/ringbuffer%E7%9A%84%E6%89%A7%E8%A1%8C.png alt=ringbuffer获取数组Index></p><p>可以看出两种 <code>Seq</code> 对 容量进行 <code>Mod</code> 操作可以将 <code>seq</code> 映射到 <code>ringbuffer</code> 的 <code>index</code> 上.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> array_index <span style=color:#f92672>=</span> seq % capacity
</span></span></code></pre></div><p>基于上面的思想，我们看 <code>ringbuffer</code> 的核心操作</p><ul><li>插入元素 <code>buffer[++writeSeq % capacity] = element</code>, 在插入元素时候先将 <code>writeSeq + 1</code>, 然后<code>Mod操作</code> 插入元素</li><li>消费元素 <code>element = buffer[readSeq++ % capacity]</code>, 先获取元素，再 <code>redSeq + 1</code> =》 <code>reqSeq</code> 指向下一个 <code>Slot</code></li></ul><blockquote><p>消费元素，被消费的元素并不会被删除，而是保留在数组中，直到下次被覆盖。</p></blockquote><h2 id=empty-buffer-和-full-buffer>Empty Buffer 和 Full Buffer</h2><p>我们要使用 <code>RingBuffer</code> 的时候，因为是环形的，可能出现 <code>writer pointer</code> 追上 <code>reader pointer</code> 的情况。
这时候需要区分场景来处理。</p><ul><li>如果数据是旧的值或者中间值(e.g:股票代码价格), 可以直接覆盖数据，不用等待数据被消费。</li><li>如果 <code>Reader Pointer</code> 必须消费 <code>Buffer</code> 中所有的旧值（e.g:电商交易）,那就需要做 <code>waiting</code>（阻塞等等），直到<code>Buffer</code>有可用的操做的 <code>slot</code>.</li></ul><h3 id=empty-buffer-判定>Empty Buffer 判定</h3><blockquote><p>Writer Seq 比 Reader Seq 小, 则 缓冲区为空</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> isEmpty <span style=color:#f92672>=</span> writerSeq &lt; readSeq
</span></span></code></pre></div><p><img src=/ringbuffer/empty-buffer.png alt=empty-buffer></p><h3 id=full-buffer-判定>Full Buffer 判定</h3><blockquote><p>Buffer Size 和 Capacity 相等，缓冲区已满，大小等于未读元素的数量</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span> size <span style=color:#f92672>=</span> writerSeq - readSeq + <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span> isFull <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>size <span style=color:#f92672>==</span> capacity<span style=color:#f92672>)</span>
</span></span></code></pre></div><p><img src=/ringbuffer/full-buffer.png alt=empty-buffer></p><h1 id=ringbuffer-的优缺点>RingBuffer 的优缺点</h1><p>RingBuffer 优点:</p><ul><li>高效的 FIFO 缓冲区，预分配固定大小的数组，高效率的内存访问模式。</li><li>Buffer 的操作时间复杂度都是 O(1)（特别消耗元素、不需要移动元素）</li></ul><p>RingBuffer 缺点:</p><ul><li>设置 Buffer 的大小至关重要， 缓冲区过小，读取速度慢，写入操作阻塞很长。</li><li>当动态调整的时候，需要移动数据</li></ul><h1 id=代码实现>代码实现</h1><h2 id=定义>定义</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>CircularBuffer</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> capacity<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>capacity</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>capacity <span style=color:#f92672>&lt;</span> 1<span style=color:#f92672>)</span> <span style=color:#f92672>?</span> DEFAULT_CAPACITY <span style=color:#f92672>:</span> capacity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>E<span style=color:#f92672>[])</span> <span style=color:#66d9ef>new</span> Object<span style=color:#f92672>[</span><span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>capacity</span><span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>readSeq</span> <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>writeSeq</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=offer-插入>offer 插入</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span>E element<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isFull <span style=color:#f92672>=</span> writeSeq <span style=color:#f92672>-</span> readSeq <span style=color:#f92672>+</span> 1 <span style=color:#f92672>==</span> capacity<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isFull<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>int</span> nextWriteSeq <span style=color:#f92672>=</span> writeSeq <span style=color:#f92672>+</span> 1<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            data<span style=color:#f92672>[</span>nextWriteSeq <span style=color:#f92672>%</span> capacity<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> element<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>            writeSeq<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><h2 id=poll-读取>poll 读取</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>public</span> E <span style=color:#a6e22e>poll</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>boolean</span> isEmpty <span style=color:#f92672>=</span> writeSeq <span style=color:#f92672>&lt;</span> readSeq<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>isEmpty<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            E nextElement <span style=color:#f92672>=</span> data<span style=color:#f92672>[</span>readSeq <span style=color:#f92672>%</span> capacity<span style=color:#f92672>];</span>
</span></span><span style=display:flex><span>            readSeq<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> nextElement<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=ut>UT</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a6e22e>@BeforeEach</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initBuffer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        buffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CircularBuffer<span style=color:#f92672>(</span>10<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Wocao&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testOffer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mmp&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span>2<span style=color:#f92672>,</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>size</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testPoll</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        assertTrue<span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mmp2&#34;</span><span style=color:#f92672>));</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Wocao&#34;</span><span style=color:#f92672>,</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>        assertEquals<span style=color:#f92672>(</span><span style=color:#e6db74>&#34;mmp2&#34;</span><span style=color:#f92672>,</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>());</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><h2 id=线程安全的>线程安全的</h2><p>这边只考虑 单一生产者和单一消费者情况， 所以在数组上无争用，可以不使用锁。只需要保证 两个 <code>Seq</code> 的可见性</p><ul><li><code>producer</code> 生产数据写入 <code>buffer</code> 并增加 <code>writeSeq</code></li><li><code>consumer</code> 从 <code>buffer</code> 消费数据，并增加 <code>readSeq</code></li></ul><p>只需要给 <code>writeSeq</code> ，<code>readSeq</code> 保证 <code>volatile</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> readSeq <span style=color:#f92672>=</span> 0<span style=color:#f92672>,</span> writeSeq <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>1<span style=color:#f92672>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    CircularBuffer buffer <span style=color:#f92672>=</span>  <span style=color:#66d9ef>new</span> CircularBuffer<span style=color:#f92672>(</span>5<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Test</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testProducerConsumer</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 10<span style=color:#f92672>;)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span>buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>offer</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;element:&#34;</span> <span style=color:#f92672>+</span> i<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;produced &#34;</span> <span style=color:#f92672>+</span> i <span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                    i<span style=color:#f92672>++;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>new</span> Thread<span style=color:#f92672>(()</span> <span style=color:#f92672>-&gt;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span>0<span style=color:#f92672>;</span> i <span style=color:#f92672>&lt;</span> 10<span style=color:#f92672>;</span> <span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                String c <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>String<span style=color:#f92672>)</span> buffer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#f92672>(</span> c <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;consumed:&#34;</span> <span style=color:#f92672>+</span> c<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}).</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            Thread<span style=color:#f92672>.</span><span style=color:#a6e22e>sleep</span><span style=color:#f92672>(</span>5000<span style=color:#f92672>);</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>InterruptedException e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span></code></pre></div><p>输出</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>produced <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>consumed:element:0
</span></span><span style=display:flex><span>consumed:element:1
</span></span><span style=display:flex><span>consumed:element:2
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>consumed:element:3
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>consumed:element:4
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>8</span>
</span></span><span style=display:flex><span>consumed:element:5
</span></span><span style=display:flex><span>consumed:element:6
</span></span><span style=display:flex><span>consumed:element:7
</span></span><span style=display:flex><span>consumed:element:8
</span></span><span style=display:flex><span>consumed:element:9
</span></span><span style=display:flex><span>produced <span style=color:#ae81ff>9</span>
</span></span></code></pre></div><p>可以看出，当生产者线程发现无法写入的时候（在 循环中 等待一个空的 slot），消费者线程从 buffer 中获取到 null，继续执行，不打印。</p><p>上面代码实现在 <a href=https://github.com/pinkhello/blog-code/blob/main/j-code>github 代码</a></p></div></article><div class=blog-post-comments><div id=disqus_thread><script type=text/javascript>(function(){var t,e=document.createElement('script');e.type='text/javascript',e.async=!0,t='pinkhello',e.src='//'+t+'.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&text=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&is_video=false&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&body=Check out this article: https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&title=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&name=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer&description=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fpinkhello.cc%2fposts%2f45-%25E5%25A6%2582%25E4%25BD%2595%25E5%258E%25BB%25E5%25AE%259E%25E7%258E%25B0ringbuffer%2f&t=%e5%a6%82%e4%bd%95%e5%8e%bb%e5%ae%9e%e7%8e%b0RingBuffer" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick="return $('#nav-footer').toggle(),!1" aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick="return $('#share-footer').toggle(),!1" aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick="$('html, body').animate({scrollTop:0},'fast')" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2022 pinkhello</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>Posts</a></li><li><a href=/categories>Category</a></li><li><a href=/tags>Tag</a></li><li><a href=/index.xml>Rss</a></li><li><a href=/jobs>Job</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script>
<script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}}</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script></html>